<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36" version="26.2.9">
  <diagram name="Page-1" id="NSVxYJOA4GDVEOJFEL16">
    <mxGraphModel dx="874" dy="1531" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <UserObject label="// In server/methods/webauthn.ts&#xa;Meteor.methods({&#xa;  &#39;webauthn.register.start&#39;(userId: string) {&#xa;    check(userId, String);&#xa;    const user = Meteor.users.findOne(userId);&#xa;    if (!user) throw new Meteor.Error(&#39;not-found&#39;);&#xa;    &#xa;    const options = generateRegistrationOptions({&#xa;      rpName: &#39;Rocket.Chat&#39;,&#xa;      rpID: new URL(Meteor.absoluteUrl()).hostname,&#xa;      userID: userId,&#xa;      userName: user.username,&#xa;      excludeCredentials: user.services?.webauthn?.map(c =&gt; ({&#xa;        id: c.credentialId,&#xa;        type: &#39;public-key&#39;&#xa;      }))&#xa;    });&#xa;&#xa;    WebAuthnChallenges.insert({&#xa;      userId,&#xa;      challenge: options.challenge,&#xa;      operation: &#39;registration&#39;,&#xa;      createdAt: new Date()&#xa;    });&#xa;&#xa;    return options;&#xa;  }&#xa;});" link="sequenceDiagram&#xa;    participant Client&#xa;    participant MeteorServer&#xa;    participant MongoDB&#xa;    &#xa;    Client-&gt;&gt;MeteorServer: Meteor.call(&#39;webauthn.register.start&#39;)&#xa;    MeteorServer-&gt;&gt;MongoDB: Insert challenge (TTL 2min)&#xa;    MeteorServer--&gt;&gt;Client: {options, meteorToken}&#xa;    &#xa;    Client-&gt;&gt;Client: credentials.create({publicKey: options})&#xa;    Client-&gt;&gt;MeteorServer: Meteor.call(&#39;webauthn.register.finish&#39;, {attestation, meteorToken})&#xa;    MeteorServer-&gt;&gt;MongoDB: Verify challenge&#xa;    MeteorServer-&gt;&gt;Server: verifyRegistrationResponse()&#xa;    MeteorServer-&gt;&gt;MongoDB: Users.update({$push: {&#39;services.webauthn&#39;: credential}})&#xa;    MeteorServer--&gt;&gt;Client: {success: true}" id="JN1MgxtYlR3WPIgTjP6B-1">
          <mxCell style="text;whiteSpace=wrap;strokeColor=light-dark(transparent,#E6E6E6);textShadow=0;fontStyle=0;spacingTop=1;spacing=5;verticalAlign=bottom;labelBackgroundColor=default;horizontal=1;fontSize=15;fontFamily=Courier New;" vertex="1" parent="1">
            <mxGeometry x="80" y="-160" width="560" height="520" as="geometry" />
          </mxCell>
        </UserObject>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
